---
title: "EDA"
output: html_document
---

```{r}
library(tidyverse)
library(lme4)
```

```{r}
Judge  <- read_csv("Data/judge_batting_2024.csv")
Ohtani <- read_csv("Data/ohtani_batting_2024.csv")
Betts  <- read_csv("Data/betts_batting_2024.csv")
```

```{r}
#Re-orders the data into time increasing instead of time decreasing
Judge1 <- Judge %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
Ohtani1 <- Ohtani %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
Betts1 <- Betts %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
```


```{r warning=FALSE}
Judge2 <- Judge1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
Ohtani2 <- Ohtani1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
Betts2 <- Betts1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
```

```{r}
Judge3 <- cbind(
  Judge1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Judge2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Judge2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Judge")
Ohtani3 <- cbind(
  Ohtani1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Ohtani2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Ohtani2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Ohtani")
Betts3 <- cbind(
  Betts1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Betts2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Betts2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Betts")

Dataset <- rbind(
  Judge3,
  Ohtani3,
  Betts3
)
```

```{r}
Judge3 <- Judge3 %>%
  mutate(`hits last week` = 0)

temp <- numeric(length(Judge3$week)+1)
temp[1:length(Judge3$week)+1] <- Judge3$hits
temp <- temp[-length(temp)]
temp

Judge3 <- Judge3 %>%
  mutate(`hits last week` = temp)

Pois1 <- glm(`good hits` ~ offset(log(pitches)) + `hits last week`, family = poisson, data=Judge3)
summary(Pois1)
```

$$
\hat{y}_t \sim Poisson(\hat{\lambda}_t)
$$

$$
log(\hat{\lambda}_t)=
$$

```{r}

GeneralPois <- glmer(`good hits` ~ offset(log(pitches))+`hits last week`, family=poisson, data=Judge3)
```




