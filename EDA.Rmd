---
title: "EDA"
output: pdf_document
---

```{r include=FALSE}
library(tidyverse)
library(tinytex)
library(lme4)
```

```{r include=FALSE}
Judge  <- read_csv("Data/judge_batting_2024.csv")
Ohtani <- read_csv("Data/ohtani_batting_2024.csv")
Betts  <- read_csv("Data/betts_batting_2024.csv")
```

```{r include=FALSE}
#Re-orders the data into time increasing instead of time decreasing
Judge1 <- Judge %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
Ohtani1 <- Ohtani %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
Betts1 <- Betts %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
```


```{r warning=FALSE, include=FALSE}
Judge2 <- Judge1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
Ohtani2 <- Ohtani1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
Betts2 <- Betts1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
```

```{r include=FALSE}
Judge3 <- cbind(
  Judge1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Judge2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Judge2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Judge")
Ohtani3 <- cbind(
  Ohtani1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Ohtani2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Ohtani2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Ohtani")
Betts3 <- cbind(
  Betts1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Betts2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Betts2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Betts")

Judge3 <- Judge3 %>%
  mutate(`hits last week` = append(Judge3$hits[1:26], 0, 0))
Ohtani3 <- Ohtani3 %>%
  mutate(`hits last week` = append(Ohtani3$hits[1:26], 0, 0))
Betts3 <- Betts3 %>%
  mutate(`hits last week` = append(Betts3$hits[1:18], 0, 0),
         `hits last week`) %>%
  mutate(`hits last week` = ifelse(week == 21, 0, `hits last week`))

Dataset <- rbind(
  Judge3,
  Ohtani3,
  Betts3
)
```

```{r}
#Model 1
Pois1 <- glm(`good hits` ~ offset(log(pitches)) + `hits last week`, family = poisson, data=Dataset)
paste("MSE:", sum(residuals(Pois1)^2)/df.residual(Pois1))
Dataset <- Dataset %>%
  mutate(fittedP1 = fitted(Pois1))
```

$$
\hat{y}_t \sim Poisson(\hat{\lambda}_t)
$$

$$
log(\hat{\lambda}_t)=-4.225-0.004_\text{hits last week}
$$

```{r}
GeneralPois1 <- glmer(
  `good hits` ~ offset(log(pitches))+`hits last week` + (1|week), family="poisson", data=Dataset
)
paste("MSE:", sum(residuals(GeneralPois1)^2)/df.residual(GeneralPois1))
Dataset <- Dataset %>%
  mutate(fittedP2 = fitted(GeneralPois1))
```

```{r}
#Model 3
GeneralPois2 <- glmer(
  `good hits` ~ offset(log(pitches))+`hits last week` + (1+week|player), family="poisson", data=Dataset)
paste("MSE:", sum(residuals(GeneralPois2)^2)/df.residual(GeneralPois2))
Dataset <- Dataset %>%
  mutate(fittedP3 = fitted(GeneralPois2))
```


```{r}
deviance(Pois1)
AIC(Pois1)
deviance(GeneralPois1)
AIC(GeneralPois1)
deviance(GeneralPois2)
AIC(GeneralPois2)
```

```{r}
Dataset %>%
  ggplot(aes(x=week, color=player))+
  geom_line(aes(y=`good hits`), size=0.5)+
  geom_point(aes(y=`fittedP1`), shape=15, size=1)+
  geom_point(aes(y=`fittedP2`), shape=17, size=1)+
  geom_point(aes(y=`fittedP3`), shape=18, size=1)+
  theme_minimal()
```

```{r}
Dataset %>%
  group_by(player) %>%
  summarise(
    `weeks played` = n(),
    `tot. good hits` = sum(`good hits`),
    `avg. good hits per week` = mean(`good hits`),
    `sd. good hits per week` = var(`good hits`)
  )
```
