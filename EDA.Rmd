---
title: "EDA"
output: html_document
---

```{r}
library(tidyverse)
library(lme4)
```

```{r}
Judge  <- read_csv("Data/judge_batting_2024.csv")
Ohtani <- read_csv("Data/ohtani_batting_2024.csv")
Betts  <- read_csv("Data/betts_batting_2024.csv")
```

```{r}
#Re-orders the data into time increasing instead of time decreasing
Judge1 <- Judge %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
Ohtani1 <- Ohtani %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
Betts1 <- Betts %>%
  group_by(game_date, inning, pitch_number) %>%
  arrange(desc(game_date), .by_group = TRUE) %>%
  ungroup() %>%
  mutate(week = as.numeric(strftime(game_date, format = "%V")),
         week = week-min(week)+1)
```


```{r warning=FALSE}
Judge2 <- Judge1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
Ohtani2 <- Ohtani1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
Betts2 <- Betts1 %>%
  filter(description == "hit_into_play") %>%
  mutate(outcome = case_when(
    events == c("single", "double", "triple", "home_run", "sac_fly") ~ "HitGood",
    events != c("single", "double", "triple", "home_run", "sac_fly") ~ "HitBad"
    )
  )
```

```{r}
Judge3 <- cbind(
  Judge1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Judge2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Judge2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Judge")
Ohtani3 <- cbind(
  Ohtani1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Ohtani2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Ohtani2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Ohtani")
Betts3 <- cbind(
  Betts1 %>%
    group_by(week)%>%
    summarise(pitches = n()) %>%
    select(week, pitches),
  Betts2 %>%
    group_by(week) %>%
    summarise(hits = n()) %>%
    select(hits),
  Betts2 %>%
    group_by(week) %>%
    filter(outcome=="HitBad")%>%
    summarise(`bad hits` = n()) %>%
    select(`bad hits`)
  )%>%
  mutate(`good hits` = `hits` - `bad hits`,
         player = "Betts")

Judge3 <- Judge3 %>%
  mutate(`hits last week` = append(Judge3$hits[1:26], 0, 0))
Ohtani3 <- Ohtani3 %>%
  mutate(`hits last week` = append(Ohtani3$hits[1:26], 0, 0))
Betts3 <- Betts3 %>%
  mutate(`hits last week` = append(Betts3$hits[1:18], 0, 0),
         `hits last week`) %>%
  mutate(`hits last week` = ifelse(week == 21, 0, `hits last week`))

Dataset <- rbind(
  Judge3,
  Ohtani3,
  Betts3
)
```

```{r}
#Model 1
Pois1 <- glm(`good hits` ~ as.factor(week)+offset(log(pitches)) + `hits last week`, family = poisson, data=Dataset)
summary(Pois1)

Dataset <- Dataset %>%
  mutate(fittedP1 = fitted(Pois1))
```

$$
\hat{y}_t \sim Poisson(\hat{\lambda}_t)
$$

$$
log(\hat{\lambda}_t)=
$$

```{r}
GeneralPois1 <- glmer(
  `good hits` ~ as.factor(week)+offset(log(pitches))+`hits last week` + (1|week), family="poisson", data=Dataset
)
summary(GeneralPois1)
Dataset <- Dataset %>%
  mutate(fittedP2 = fitted(GeneralPois1))
```

```{r}
#Model 3
GeneralPois2 <- glmer(
  `good hits` ~ as.factor(week)+offset(log(pitches))+`hits last week` + (1+week|player) + (1|week), family="poisson", data=Dataset)
summary(GeneralPois2)
Dataset <- Dataset %>%
  mutate(fittedP3 = fitted(GeneralPois2))
```


```{r}
Dataset %>%
  ggplot(aes(x=week, color=player))+
  geom_point(aes(y=`good hits`))+
  #geom_line(aes(y=`fittedP1`), linetype=1)+
  #geom_line(aes(y=`fittedP2`), linetype=2)+
  geom_line(aes(y=`fittedP3`), linetype=3)
```

